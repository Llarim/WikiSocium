extends BaseWidget

block content
  div()
    div(style="margin-bottom: 4px;")
      input.input-xlarge.organization_name(type="text", id="YandexMapsWidgetInputWS_#{widget.id}", data-provide="typeahead", data-source="[]")
  div
    div(id="YandexMapsWidget_#{widget.id}_link", class="YandexMapsWidget_link link")
      Показать карту
    div(id="YandexMapsWidget_#{widget.id}", class="YandexMapsWidget_map")
  script(type="text/javascript")
      $("#YandexMapsWidget_#{widget.id}_link").on("click", function(){
        // [TODO] place mark on the map
        //$("#YandexMapsWidget_#{widget.id}").html()
        showModalWindow( "Yandex Map", "123123", [], "YandexMapsWidget_#{widget.id}" );
        
        // $(".YandexMapsWidget_container").toggle();
      });
      $(".YandexMapsWidget_container").on("click", function(){
        $(this).hide();
      });
      var YandexMapsWidgetObject_#{widget.id} = {};
      step#{step_id}FieldsList['!{widget.id}'] = new YandexMapsWidget(!{JSON.stringify(value)});  
      var YandexMapsWidgetBody_#{widget.id} = function()
      {
          YandexMapsWidgetObject_#{widget.id} = new ymaps.Map ("YandexMapsWidget_#{widget.id}", {
              center: [55.76, 37.64],
              zoom: 7
          }); 
          YandexMapsWidgetObject_#{widget.id}.controls.add('zoomControl');
          YandexMapsWidgetObject_#{widget.id}.controls.add(new ymaps.control.ScaleLine());
          
          var updateGeodata = function(){
                   // YandexMapsWidgetObject_#{widget.id}.geoObjects.removeAll();
                   if($(this).val() != "")
                   {
                       var myGeocoder = ymaps.geocode($(this).val(), {kind: 'street'});
                       myGeocoder.then(
                           function (res) {
                               var dataSource = [];
                               for(var i = 0; i < res.geoObjects.getLength(); i++)
                                   dataSource.push(res.geoObjects.get(i).properties.get('name'));

                              $("#YandexMapsWidgetInputWS_#{widget.id}").attr("data-source", JSON.stringify(dataSource));                              
                              $("#YandexMapsWidgetInputWS_#{widget.id}").data('typeahead').source = dataSource;                              
                              if(dataSource.length > 0)
                                $("#YandexMapsWidgetInputWS_#{widget.id}").data('typeahead').render($("#YandexMapsWidgetInputWS_#{widget.id}").data('typeahead').source).show()
                              
                           },
                           function (err) {
                               alert('Ошибка');
                           }
                       );
                   }
               };
               
          $("#YandexMapsWidgetInputWS_#{widget.id}").typeahead();
          $("#YandexMapsWidgetInputWS_#{widget.id}").on("keyup", updateGeodata);
      };
      if($("#YandexMapsWidget_#{widget.id}").closest(".step").is(":visible"))
         setTimeout(function(){
             ymaps.ready(YandexMapsWidgetBody_#{widget.id});                         
             // YandexMapsWidgetBody_#{widget.id}();
             // OnWidgetChanged();
      }, 1000);