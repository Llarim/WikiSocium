p Let's authentificate with twitter
p Here's can be button to start authentification. Yet we start automatically
p#status

script(type="text/javascript", src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js")
script(type="text/javascript", src="/javascripts/social_login.js")

script
  var social_name = 'tw';

  var uid = #{user.id};

  LoginInternally(social_name, uid, function(res) {
    if (res.uid != uid) { 
      // uid is wrong
    }
    else {
      if (res.uid == uid && res.status == 'success') {
        ReturnOnSuccessLogin( uid, social_name );
      }
      else if (res.uid == uid && res.status == 'user_not_found') {
        $('#status').html("User not found. Creating new");
        
        $.ajax(
        {
          url: '/users.json',
          type: 'POST',
          data: 'social_name=' + social_name + '&user[' + social_name + '_uid]=' + uid + '&user[name]=#{user.name}',
          success: function(res) {
            if (res.error == undefined) LoginInternally(social_name, uid, function(res) {
              if (res.uid == uid && res.status == 'success') {
                $('#status').html("User created. Going back to WikiSocium")
                ReturnOnSuccessLogin( uid, social_name );
              }
            });
            else {
              switch(res.error) {
                case 'email_exists' :
                  $('#status').html("E-mail already exists. Stopping creating user");
                break;
                
                default :
                  $('#status').html(JSON.stringify(res.error));
              }
            }
          },
          error: function(jqXHR, textStatus, errorThrown) {
            // To do
          }
        });
        
      }
    }
  });